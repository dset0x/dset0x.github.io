#!/bin/sh

uri_unescape() {
    perl -e 'use URI::Escape; print uri_unescape($ARGV[0])' "$1"
}


cat <<EOF > ../sitemap.xml
<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
    <url>
        <loc>https://dset0x.github.io/</loc>
        <lastmod>$(date +%F)</lastmod>
        <changefreq>10</changefreq>
        <priority>0.5</priority>
    </url>
EOF

for j in $( ls -t *.txt ); do
    [[ "$j" == index.txt ]] && continue
    i="${j%.*}"
    txt2html -ah header.html -pp top.html --outfile ../$i.html --prebegin 1 --prewhite 4 --titlefirst --underline_delimiter '' --bold_delimiter '' --italic_delimiter '' --links_dictionaries dict.dict $i.txt

    preview=$(tail -n +3 $i.txt | grep '^\S' | paste -sd " " - | sed 's/<URL:.*:\(.*\)>/\1/g' | cut -d'.' -f1)
    echo -e "<div><h2 style=\"display: inline;\"><a href=\"/$i.html\">$(head -1 "$i.txt")</a></h2> <div class=\"preview\">$preview...</div></div><br>" >> index.tmp

    dt=$(stat -c %y "$i.txt" | cut -d' ' -f1)
    cat <<EOF >> ../sitemap.xml
    <url>
        <loc>https://dset0x.github.io/$i.html</loc>
        <lastmod>$dt</lastmod>
        <changefreq>10</changefreq>
        <priority>0.5</priority>
    </url>
EOF
done

echo '</urlset>' >> ../sitemap.xml

txt2html -ah header.html -pp top.html --outfile ../index.html --prebegin 1 --prewhite 4 --title 'When software gets in the way' --underline_delimiter '' --bold_delimiter '' --italic_delimiter '' --short_line_length 80 --append_file index.tmp index.txt

rm index.tmp
