#!/usr/bin/env zsh

esc() {
    perl -e 'use HTML::Entities; print encode_entities($ARGV[0]);' "$1"
}

site_title='When software gets in the way'
site_desc='A collection of workarounds and patches to solve all life''s problems.'
domain='https://dset0x.github.io'
txt2html_args="--extract --prebegin 1 --prewhite 4 --titlefirst \
    --underline_delimiter '' --bold_delimiter '' --italic_delimiter '' \
    --links_dictionaries dict.dict"

# INDEX
echo '<h1>Home</h1>' > index.tmp

# SITEMAP
cat <<EOF > ../sitemap.xml
<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
    <url>
        <loc>$domain</loc>
        <lastmod>$(date +%F)</lastmod>
        <changefreq>daily</changefreq>
        <priority>0.5</priority>
    </url>
EOF

# FEED
cat <<EOF > ../feed.xml
<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
xmlns:content="http://purl.org/rss/1.0/modules/content/"
xmlns:wfw="http://wellformedweb.org/CommentAPI/"
xmlns:dc="http://purl.org/dc/elements/1.1/"
xmlns:atom="http://www.w3.org/2005/Atom"
xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
>
<channel>
  <title>$site_title</title>
  <link>$domain</link>
  <description>$site_desc</description>
	<atom:link href="$domain/feed.xml" rel="self" type="application/rss+xml" />
	<language>en</language>
	<sy:updatePeriod>daily</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
EOF

max_date=0
for i in $(ls -t *.txt); do
    [[ "$i" == index.txt ]] && continue
    i="${i%.*}"
    txt="$i.txt"
    html="$i.html"

    title=$(esc "$(head -n2 "$txt" | tail -n1)")
    keys=$(esc "$(head -n1 "$txt")")
    preview=$(esc "$(tail -n +4 "$txt" | grep '^\S' | paste -sd " " - | \
        sed 's/<URL:.*:\(.*\)>/\1/g' | cut -d' ' -f 1-70)")
    date=$(date -d "$(stat -c %y "$txt")" +%s)
    [[ $date -gt $max_date ]] && max_date=$date

    # ARTICLE
    {
        ./header.sh "article" "$title - $site_title" "$title" "$keys"
        echo '<article>'
        txt2html ${=txt2html_args} =(tail -n +2 "$txt")
        echo '</article>'
        cat footer.html
    } > ../"$html"

    # INDEX
    cat <<EOF >> index.tmp
    <article>
        <h2><a href="/$html">$title</a></h2>
        <div class="preview">$preview...</div>
    </article>
EOF

    # SITEMAP
    cat <<EOF >> ../sitemap.xml
    <url>
        <loc>$domain/$html</loc>
        <lastmod>$(date --date="@$date" +%F)</lastmod>
        <changefreq>monthly</changefreq>
        <priority>0.7</priority>
    </url>
EOF

    # FEED
    cat <<EOF >> ../feed.xml
  <item>
    <title>$title</title>
    <link>$domain/$html</link>
    <description>$preview</description>
    <pubDate>$(date -R --date="@$date")</pubDate>
  </item>
EOF

done

# INDEX
./header.sh "home" "$site_title" \
    "A collection of workarounds and patches to solve all life's problems." \
    "hacks,patches,perl,python,linux,terminal,blog" > ../index.html
txt2html ${=txt2html_args} --short_line_length 80  \
    --append_file index.tmp index.txt >> ../index.html
cat footer.html >> ../index.html
rm index.tmp

# SITEMAP
echo '</urlset>' >> ../sitemap.xml

# FEED
cat <<EOF >> ../feed.xml
    <lastBuildDate>$(date -R --date="@$max_date")</lastBuildDate>
  </channel>
</rss>
EOF
