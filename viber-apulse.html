<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Getting Viber for Linux to play nice with apulse - When software gets in the way</title>
<meta charset="utf-8">
<meta name="description" content="Viber for Linux seems to work fine with apulse, except for taking the liberty of changing my system&#39;s volume to 100% shortly after starting. After no luck with trying to figure out if it was leveraging apulse itself to do this, I started believing it was calling alsa despite being a pulseaudio application: Unfortunately, this produces too much noise. Looking at `/usr/include/alsa/mixer.h` it&#39;s easy to locate possibly used functions: In">
<meta name="keywords" content="linux,viber,apulse,pulseaudio,ld_preload,volume">
<meta name="author" content="Dimitrios Semitsoglou-Tsiapos">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico"/>
<link rel="alternate" type="application/rss+xml" title="When software gets in the way" href="/feed.xml" />
<style>
    body {font-family: monospace;}
    h1, h2 {font-size:medium; margin: 0.67em 0 0.67em 0;}
    h2 {font-weight: initial;}
    p {width: 79ch;}
    .preview {padding-left: 4ch; opacity: 0.7; width: 79ch;}
    body {background-color: #F3F3F3;
          background-image: url('/carrot.png');
          background-position: right bottom;
          background-repeat: no-repeat;
          background-attachment: fixed;

          display: flex;
          min-height: 100vh;
          max-height: 100vh;
          flex-direction: column;
      }
</style>
</head>
<body>
<div id="nav">
<a href="/">Home</a> |
GitHub {
    <a href="https://github.com/search?o=desc&q=author:dset0x+&s=committer-date&type=Commits&utf8=✓">Commits</a>,
    <a href="https://github.com/search?o=desc&q=author:dset0x+&s=created&type=Issues&utf8=✓">Issues</a>
}
<hr>
</div>
<div id="content">
<h1><a name="section_1">Getting Viber for Linux to play nice with apulse</a></h1>

<p>Viber for Linux seems to work fine with apulse,
</p>
<pre>
    $ apulse /opt/viber/Viber
</pre>
<p>except for taking the liberty of changing my system's volume to 100% shortly
after starting.
</p>
<p>After no luck with trying to figure out if it was leveraging apulse itself to
do this,
</p>
<pre>
    $ apulse ltrace -f -e '@libpulse*' /opt/viber/Viber
</pre>
<p>I started believing it was calling alsa despite being a pulseaudio
application:
</p>
<pre>
    $ apulse ltrace -f -e '@libasound*' /opt/viber/Viber
</pre>
<p>Unfortunately, this produces too much noise.
</p>
<p>Looking at `/usr/include/alsa/mixer.h` it's easy to locate possibly used
functions:
</p>
<pre>
    int snd_mixer_selem_set_playback_volume(...);
    int snd_mixer_selem_set_capture_volume(...);
    int snd_mixer_selem_set_playback_volume_all(...);
    int snd_mixer_selem_set_capture_volume_all(...);
    int snd_mixer_selem_set_playback_volume_range(...);
</pre>
<p>In fact `strings` hints that this may be the case:
</p>
<pre>
    $ strings /opt/viber/Viber| grep 'volume'
    pa_cvolume_set
    pa_context_set_sink_input_volume
    pa_context_set_source_volume_by_index
    snd_mixer_selem_set_playback_volume_all
    snd_mixer_selem_get_playback_volume
    snd_mixer_selem_has_playback_volume
    snd_mixer_selem_get_playback_volume_range
    snd_mixer_selem_has_capture_volume
    snd_mixer_selem_set_capture_volume_all
    snd_mixer_selem_get_capture_volume
    snd_mixer_selem_get_capture_volume_range
</pre>
<p>Armed with possible function names, voila:
</p>
<pre>
    $ apulse ltrace -f -e '*set*volume*@libasound*' /opt/viber/Viber
    [...]
    [pid 17824] libasound.so.2-&gt;snd_mixer_selem_set_playback_volume(0x7f1f7d0efbf0, 0, 110, 0) = 0
    [pid 17824] libasound.so.2-&gt;snd_mixer_selem_set_playback_volume(0x7f1f7d0efbf0, 1, 110, 1) = 0
    [...]
</pre>
<p>Looks like it sets it to 110% for good measure (and alsa happily obliges)!
</p>
<p>Let's go ahead and take that function away from it via `LD_PRELOAD`:
</p>
<pre>
    #include
    int snd_mixer_selem_set_playback_volume(snd_mixer_elem_t *elem, snd_mixer_selem_channel_id_t channel, long value) {
    return 0;
    }

    $ gcc -shared -fPIC viber_unvol.c -o viber_unvol.so
</pre>
<p>And there you go, no more automatic volume changing:
</p>
<pre>
    $ LD_PRELOAD=$LD_PRELOAD:$PWD/viber_unvol.so apulse /opt/viber/Viber
</pre></div>
<div style="flex: 1; min-height: 129px; position: relative;"><img src="carrot.png" style="bottom: 0; position: absolute; right: 0;"/></div>
</body>
</html>
